import cv2
import mediapipe as mp
import pickle
import numpy as np

# ============================================================================
# ЗАГРУЗКА МОДЕЛИ
# ============================================================================
print("Загрузка модели Random Forest...")
with open('random_forest.pkl', 'rb') as f:
    model = pickle.load(f)
print("Модель загружена")

# ============================================================================
# НАСТРОЙКА MEDIAPIPE (ДЕТЕКЦИЯ РУК)
# ============================================================================
mp_hands = mp.solutions.hands
hands = mp_hands.Hands(
    static_image_mode=False,  # Режим для видео (не для статичных изображений)
    max_num_hands=1,  # Максимум одна рука в кадре
    min_detection_confidence=0.5  # Минимальная уверенность детекции (50%)
)

# ============================================================================
# ЗАХВАТ ВИДЕО С КАМЕРЫ
# ============================================================================
cap = cv2.VideoCapture(0)  # 0 - индекс основной камеры

# ============================================================================
# ОСНОВНОЙ ЦИКЛ РАСПОЗНАВАНИЯ
# ============================================================================

while True:
    # 1. ЧТЕНИЕ КАДРА С КАМЕРЫ
    ret, frame = cap.read()
    if not ret:
        print("Ошибка чтения кадра")
        break

    # 2. ОТРАЖЕНИЕ КАДРА (чтобы было как в зеркале)
    frame = cv2.flip(frame, 1)

    # 3. ПРЕОБРАЗОВАНИЕ BGR → RGB (нужен для MediaPipe)
    rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    # 4. ДЕТЕКЦИЯ РУКИ
    results = hands.process(rgb)

    # 5. ЕСЛИ РУКА ОБНАРУЖЕНА
    if results.multi_hand_landmarks:
        hand = results.multi_hand_landmarks[0]  # Берём первую руку
        wrist = hand.landmark[0]  # Точка запястья (0-я точка)

        # ------------------------------------------------------------
        # 6. ПОДГОТОВКА ПРИЗНАКОВ ДЛЯ МОДЕЛИ
        # ------------------------------------------------------------
        # MediaPipe даёт 21 точку на руке, для каждой точки:
        # - x, y, z координаты (нормализованные 0..1)
        # Нормализуем относительно запястья (wrist)

        features = []  # Здесь будут 21×3 = 63 признака

        # X координаты (относительно запястья)
        for landmark in hand.landmark:
            features.append(landmark.x - wrist.x)

        # Y координаты
        for landmark in hand.landmark:
            features.append(landmark.y - wrist.y)

        # Z координаты
        for landmark in hand.landmark:
            features.append(landmark.z - wrist.z)

        # ------------------------------------------------------------
        # 7. ПРЕДСКАЗАНИЕ БУКВЫ ASL
        # ------------------------------------------------------------
        features_array = np.array(features).reshape(1, -1)  # Преобразуем в 2D массив
        prediction = model.predict(features_array)[0]  # Предсказание буквы

        # ------------------------------------------------------------
        # 8. ОТОБРАЖЕНИЕ РЕЗУЛЬТАТОВ
        # ------------------------------------------------------------
        # Рисуем скелет руки (точки + соединения)
        mp.solutions.drawing_utils.draw_landmarks(
            frame,  # Изображение для рисования
            hand,  # Обнаруженная рука
            mp_hands.HAND_CONNECTIONS  # Соединения между точками
        )

        # Отображаем распознанную букву
        cv2.putText(
            frame,  # Изображение
            f"Letter: {prediction}",  # Текст с буквой
            (50, 50),  # Позиция (x, y)
            cv2.FONT_HERSHEY_SIMPLEX,  # Шрифт
            1.5,  # Масштаб
            (0, 255, 0),  # Цвет (зелёный)
            3  # Толщина
        )

    # 9. ЕСЛИ РУКА НЕ ОБНАРУЖЕНА
    else:
        cv2.putText(
            frame,
            "Show your hand",  # Инструкция
            (50, 50),
            cv2.FONT_HERSHEY_SIMPLEX,
            1,
            (0, 0, 255),  # Цвет (красный)
            2
        )

    # 10. ПОКАЗЫВАЕМ ОКНО С ВИДЕО
    cv2.imshow('ASL Recognition - Random Forest', frame)

    # 11. ВЫХОД ПО КЛАВИШЕ 'q'
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# ============================================================================
# ОЧИСТКА РЕСУРСОВ
# ============================================================================
cap.release()  # Освобождаем камеру
cv2.destroyAllWindows()  # Закрываем все окна OpenCV